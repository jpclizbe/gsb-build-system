<?php
include 'common/packages_config_inc.php';
function error() {
        print ("<h3>Error - no packages found</h3>\n"
              ."</p><a href='/?op=packages'>Back...</a></p>\n");
        include('common/footer_inc.php');
        exit();
}
if ( ! isset($_REQUEST['mode']) )
	$mode = 'home';
else
	$mode = $_REQUEST['mode'];
if ( preg_match('/[^a-z]/', $mode) )
	$mode = 'home';

function package_find($search, $verdir)
{
	include 'common/packages_config_inc.php';
	$search = str_replace('+', '\+', $search);
	# Okay, let's read in PACKAGES.TXT - using grep etc is probably faster than
	# PHP
	$firstline = `grep -n "PACKAGE NAME" $path/$verdir/PACKAGES.TXT | head -n 1 | cut -f 1 -d :`;
	$size = `wc -l $path/$verdir/PACKAGES.TXT | awk '{print $1}'`;
	$packages = explode("\n\n", trim(shell_exec("tail -n " .
		($size - $firstline) . " $path/$verdir/PACKAGES.TXT")));
	foreach ($packages as $package)
	{
		if ( ! preg_match("#^PACKAGE NAME:.+$search#", $package) )
			continue;
		$desc = "";
		$isDesc = false;
		foreach (explode("\n", $package) as $line)
		{
			if ( preg_match("#^PACKAGE NAME:#", $line) )
				{
					$name = substr($line, strpos($line, ":") + 3);
					$name = substr($name, 0, strrpos($name, ".")); # get rid of extension
					continue;
				}
			if ( preg_match("#^PACKAGE LOCATION:#", $line) ) # s/3/5/ for ./
				{ $location = substr($line, strpos($line, ":") + 5); continue; }
			if ( preg_match("#^PACKAGE SIZE \(compressed\):#", $line) )
				{ $compressed = substr($line, strpos($line, ":") + 3); continue; }
			if ( preg_match("#^PACKAGE SIZE \(uncompressed\):#", $line) )
				{ $uncompressed = substr($line, strpos($line, ":") + 3); continue; }
			if ( preg_match("#^PACKAGE DESCRIPTION:#", $line) )
			{ $isDesc = true; continue; }
			if ( $isDesc )
				$desc .= substr($line, strpos($line, ":") + 2) . "\n";
		}
		$matchingPacks[] = array(
			'name' => "$name",
			'location' => "$location",
			'compressed' => "$compressed",
			'uncompressed' => "$uncompressed",
			'desc' => "$desc"
			);
	}
	# and the same again for extra/
	$firstline = `grep -n "PACKAGE NAME" $path/$verdir/extra/PACKAGES.TXT | head -n 1 | cut -f 1 -d :`;
	$size = `wc -l $path/$verdir/extra/PACKAGES.TXT | awk '{print $1}'`;
	$packages = explode("\n\n", trim(shell_exec("tail -n " .
		($size - $firstline) . " $path/$verdir/extra/PACKAGES.TXT")));
	foreach ($packages as $package)
	{
		if ( ! preg_match("#^PACKAGE NAME:.+$search#", $package) )
			continue;
		$desc = "";
		$isDesc = false;
		foreach (explode("\n", $package) as $line)
		{
			if ( preg_match("#^PACKAGE NAME:#", $line) )
				{
					$name = substr($line, strpos($line, ":") + 3);
					$name = substr($name, 0, strrpos($name, ".")); # get rid of extension
					continue;
				}
			if ( preg_match("#^PACKAGE LOCATION:#", $line) ) # s/3/5/ for ./
				{ $location = substr($line, strpos($line, ":") + 5); continue; }
			if ( preg_match("#^PACKAGE SIZE \(compressed\):#", $line) )
				{ $compressed = substr($line, strpos($line, ":") + 3); continue; }
			if ( preg_match("#^PACKAGE SIZE \(uncompressed\):#", $line) )
				{ $uncompressed = substr($line, strpos($line, ":") + 3); continue; }
			if ( preg_match("#^PACKAGE DESCRIPTION:#", $line) )
			{ $isDesc = true; continue; }
			if ( $isDesc )
				$desc .= substr($line, strpos($line, ":") + 2) . "\n";
		}
		$matchingPacks[] = array(
			'name' => "$name",
			'location' => "$location",
			'compressed' => "$compressed",
			'uncompressed' => "$uncompressed",
			'desc' => "$desc"
			);
	}
	# and yet again for patches, if it exists
	if (file_exists("$path/$verdir/patches/PACKAGES.txt") )
	{
		$firstline = `grep -n "PACKAGE NAME" $path/$verdir/patches/PACKAGES.TXT | head -n 1 | cut -f 1 -d :`;
		$size = `wc -l $path/$verdir/patches/PACKAGES.TXT | awk '{print $1}'`;
		$packages = explode("\n\n", trim(shell_exec("tail -n " .
			($size - $firstline) . " $path/$verdir/patches/PACKAGES.TXT")));
		foreach ($packages as $package)
		{
			if ( ! preg_match("#^PACKAGE NAME:.+$search#", $package) )
				continue;
			$desc = "";
			$isDesc = false;
			foreach (explode("\n", $package) as $line)
			{
				if ( preg_match("#^PACKAGE NAME:#", $line) )
					{
						$name = substr($line, strpos($line, ":") + 3);
						$name = substr($name, 0, strrpos($name, ".")); # get rid of extension
						continue;
					}
				if ( preg_match("#^PACKAGE LOCATION:#", $line) ) # s/3/5/ for ./
					{ $location = substr($line, strpos($line, ":") + 5); continue; }
				if ( preg_match("#^PACKAGE SIZE \(compressed\):#", $line) )
					{ $compressed = substr($line, strpos($line, ":") + 3); continue; }
				if ( preg_match("#^PACKAGE SIZE \(uncompressed\):#", $line) )
					{ $uncompressed = substr($line, strpos($line, ":") + 3); continue; }
				if ( preg_match("#^PACKAGE DESCRIPTION:#", $line) )
				{ $isDesc = true; continue; }
				if ( $isDesc )
					$desc .= substr($line, strpos($line, ":") + 2) . "\n";
			}
			$matchingPacks[] = array(
				'name' => "$name",
				'location' => "$location",
				'compressed' => "$compressed",
				'uncompressed' => "$uncompressed",
				'desc' => "$desc"
				);
		}
	}
	return $matchingPacks;
}

?>

<h2>FRG Package Browser</h2>

<?php if ( $mode == 'home' ) { ?>
<table border='0' cellpadding='4' >
<?php
foreach ($versions as $version => $dir )
{
print "<tr class='versionRow'>
	<td class='version'>$distro-$version</td>
	<td>
		[
		<a href='/?op=packages&amp;mode=browse&amp;ver=$version&amp;dir=frgnome'>frgnome</a> |
		<a href='/?op=packages&amp;mode=browse&amp;ver=$version&amp;dir=extras'>extras</a> |\n";
if ( file_exists("$path/$dir/patches") )
	print "<a href='/?op=packages&amp;mode=browse&amp;ver=$version&amp;dir=patches'>patches</a> | ";
else
	print "patches | ";
if ( file_exists("$path/$dir/testing") )
    print "<a href='/?op=packages&amp;mode=browse&amp;ver=$version&amp;dir=testing'>testing</a> ";
else
    print "testing";
print "\n]\n</td>\n";
print "<td><tt>(" . date("Y/m/d H:i T", filemtime("$path/$dir/CHECKSUMS.md5")) .
	")</tt></td>\n";
print "</tr>";
}
?>
</table>
<?php
} # if ( $mode == 'home' )
if ( $mode == 'browse' ) {

if ( ! isset($_REQUEST['ver']) )
	error();
if ( preg_match('/[^a-z.0-9]/', $_REQUEST['ver']) )
	error();
if ( ! isset($_REQUEST['dir']) )
	error();
if ( preg_match('#[^a-z/._]#', $_REQUEST['dir']) )
	error();
	
$ver = $_REQUEST['ver'];
if ( ! isset($versions["$ver"]) )
    error();
else
	$verdir = $versions["$ver"];
$dir = $_REQUEST['dir'];

if ( ! file_exists("$path/$verdir/$dir") )
	error();

if ( $dir == "" )
{
	print "<h3>pwd: $distro-$ver/</h3>\n";
	print "<a href='/?op=packages'>../</a><br />\n";
}
else
{
	print "<h3>pwd: $distro-$ver/$dir/</h3>\n";
	strpos($dir, "/")
  	? $parentdir = preg_replace('#([^/]+)/[^\\\]+$#', '\1', $dir)
		: $parentdir = "";
	print "<a href='/?op=packages&amp;mode=browse&amp;ver=$ver&amp;dir=$parentdir'>../</a><br />\n";
}
$dh = @opendir("$path/$verdir/$dir");
while ($filename = @readdir($dh))
{
	if ( array_search($filename, $hideDirs))
		continue;
	$dir == ""
		? $link = $filename
		: $link = "$dir/$filename";
	$link = urlencode($link);
	if ( is_dir("$path/$verdir/$dir/$filename") )
		print "&nbsp;&nbsp;<a href='/?op=packages&amp;mode=browse&amp;ver=$ver&amp;dir=$link'>/<tt>$filename</tt></a><br />\n";
	else
	{
		$parts = explode('.', $filename);
		$ext = $parts[sizeof($parts) - 1];
		if ( $ext == $pkgExt)
			print "&nbsp;&nbsp;<a href='/?op=packages&amp;mode=pack&amp;ver=$ver&amp;path=$link'><tt>$filename</tt></a><br />\n";
	}
}
print "\n";
} # if ( $mode == 'browse' )
if ( $mode == 'findpkg' ) {
	if ( preg_match("#[^a-zA-Z0-9.\-_+]#", $_REQUEST['package']) )
		error();
	if ( ! isset($_REQUEST['ver']) )
	error();
	if ( preg_match('/[^a-z\.0-9]/', $_REQUEST['ver']) )
	  error();

	$search = $_REQUEST['package'];
	$ver = $_REQUEST['ver'];
	if ( ! isset($versions[$ver]) )
		error();
	$verdir = $versions[$ver];
	if ( ! file_exists("$path/$verdir/PACKAGES.TXT") )
		error();

  $matchingPacks = package_find($search, $verdir);

	print "<p>Found " . sizeof($matchingPacks) . " matching packs:</p>\n";
	print "<ul>\n";
	foreach ($matchingPacks as $matchingPack)
	{
		$path = $matchingPack['location'] . '/' . $matchingPack['name'];
		print "<li><a href='/?op=packages&amp;mode=pack&amp;ver=$ver&amp;path="	
			. urlencode($path) . "'>$path</a></li>\n";
	}
	print "</ul>\n<p><a href='/?op=packages'>Back</a></p>\n";		
} # if ( $mode == 'findpkg' )
if ( $mode == 'findfile' )
{
	if ( ! isset($_REQUEST['ver']) )
	 error();
	if ( preg_match('/[^a-z\.0-9]/', $_REQUEST['ver']) )
	  error();
	if ( preg_match('/[^onf]/', $_REQUEST['wildcard']) )
		error();
	if ( preg_match('/[^a-zA-Z0-9_*?\\-.+]/', $_REQUEST['file']) )
		error();
	if ( preg_match('/[^a-z]/', $_REQUEST['dir']) )
		error();

	$dir = $_REQUEST['dir'];
	if ( $dir != "slackware" AND $dir != "extra" AND $dir != "patches" )
		error();
	$search = $_REQUEST['file'];
	$wildcard = $_REQUEST['wildcard'];
	
	$ver = $_REQUEST['ver'];
	if ( ! isset($versions[$ver]) )
		error();
	else
		$verdir = $versions[$ver];

	if ( $fastMode == false )
	{
		if ( ! file_exists("$path/$verdir/$dir/MANIFEST.bz2") )
			error();
		
		# MANIFEST.bz2 is _way_ to big to load in here... shell out to bzgrep methinks
		$string = str_replace(".", "\.", $search);
		if ( $wildcard == "on" )
		{
			$flag = "";
			$search = str_replace("*", ".\+", $search);
			$search = str_replace("?", ".", $search);
		}
		else
			$flag = "";
		$line = `bzgrep -ne "/$search$post" $path/$verdir/$dir/MANIFEST.bz2 | cut -f 1 -d :`;
		if ( $line == "" )
			print "<p>File not found.</p><p><a href='/?op=packages'>Back</a></p>\n";
		else
		{
			$packlines = explode("\n", `bzgrep -n '||   Package:  ' $path/$verdir/$dir/MANIFEST.bz2`);
			$pack = "ERROR";
			foreach ($packlines as $packline)
			{
				if (substr($packline, 0, strpos($packline, ":")) + 0 > $line + 0)
					break;
				$pack = substr($packline, strrpos($packline, ":") + 5);
				$pack = substr($pack, 0, strrpos($pack, "."));
			}
			print "<p>Found in <a href='/?op=packages&amp;mode=pack&amp;ver=$ver&amp;path=" . 
				urlencode($dir/$pack) . "'>$dir/$pack</a>.</p><p><a href='/?op=packages'>Back</a></p>\n";
		}
	} else {
		# Use MySQL instead of brute forcing it
		$link = mysql_connect(
			$mysql_server,
			$mysql_user,
			$mysql_pass);
		mysql_select_db($mysql_db);
		$sqlVer = str_replace('.', 'dot', $ver);
		if ( $wildcard == 'off')
			$result = mysql_query("SELECT * FROM $distro$sqlVer WHERE file LIKE '%/$search';");
		else
		{
			$search = str_replace('*', '%', $search);
			$search = str_replace('?', '_', $search);
			$result = mysql_query("SELECT * FROM $distro$sqlVer WHERE file like '%/$search';");
		}
		if (mysql_num_rows($result) == 0)
			print "<p>File not found.</p><p><a href='/?op=packages'>Back</a></p>\n";
		else
		{
			print "<p>Found in " . mysql_num_rows($result) . " packs:</p><ul>\n";
			while ($row = mysql_fetch_assoc($result))
			{
				$pack = substr($row['package'], 0, strrpos($row['package'], '.'));
				print "<li><a href='/?op=packages&amp;mode=pack&amp;ver=$ver&amp;path=$pack'>$pack</a> - " .
					$row['file'] . "</li>\n";
			}
		}
		mysql_free_result($result);
		mysql_close($link);
		print "</ul>\n<p><a href='/?op=packages'>Back</a></p>\n";
	}
} # if ( $mode == 'findfile' )
if ( $mode == 'pack' ) {
	if ( ! isset($_REQUEST['ver']) )
		error();
	if ( preg_match('/[^a-z\.0-9]/', $_REQUEST['ver']) )
		error();
	$ver = $_REQUEST['ver'];
	if ( ! isset($versions[$ver]) )
		error();
	$verdir = $versions[$ver];
	if ( ! isset($_REQUEST['path']) )
		error();
	if ( strstr('../', $_REQUEST['path']) )
		error();
	$filePath = $_REQUEST['path'];
	$fileName = substr($filePath, strrpos($filePath, "/") + 1);
	
	$matchingPacks = package_find($fileName, $verdir);
	if ( sizeof($matchingPacks) == 0 )
		print "<p>Error: invalid number of matching packs.</p><p><a href='/?op=packages'>Back</a></p>\n";
	else
	{
		print "<h3>" . $matchingPacks[0]['name'] . "</h3>\n<p>
Location: <a href='http://mirror.datapipe.net/norlug/$distro/$verdir/$filePath'><tt>$filePath<!--.$pkgExt--></tt></a><br />
Compressed size: " . $matchingPacks[0]['compressed'] . "<br />
Uncompressed size: " . $matchingPacks[0]['uncompressed'] . "
</p>

<p><a href='/?op=packages&amp;mode=browse&amp;ver=$ver&amp;dir=" . substr($filePath, 0, strpos($filePath, $fileName) - 1) . "'>../</a></p>
	
<pre class=\"packdesc\">" . trim($matchingPacks[0]['desc']) . "</pre>";
	}
} # if ( $mode == 'pack' )
?>
<?php if($mode !== "pack") { ?>
<hr />
<p style="font-size: x-small">This package browser is based on GPL code from the <a
href="http://slamd64.com/">Slamd64 Linux Project</a>'s package browser.</p>
<?php } ?>
